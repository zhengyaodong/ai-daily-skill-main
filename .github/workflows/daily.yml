name: AI Daily News Generator
env:
    # K2 å¤§æ¨¡å‹é…ç½®ï¼ˆæ·»åŠ è¿™éƒ¨åˆ†ï¼‰
    K2_API_KEY: ${{ secrets.K2_API_KEY }}
    K2_BASE_URL: ${{ secrets.K2_BASE_URL || 'https://api.moonshot.cn/v1' }}
    K2_MODEL: ${{ secrets.K2_MODEL || 'kimi-k2-0905-preview' }}
    K2_API_ENDPOINT: ${{ secrets.K2_API_ENDPOINT || '/chat/completions' }}

    # å…¼å®¹æ—§é…ç½®ï¼ˆä¿æŒï¼‰
    ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
    ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}

    # é‚®ä»¶é€šçŸ¥é…ç½®ï¼ˆä¿æŒï¼‰
    SMTP_HOST: ${{ secrets.SMTP_HOST }}
    SMTP_PORT: ${{ secrets.SMTP_PORT }}
    SMTP_USER: ${{ secrets.SMTP_USER }}
    SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
    NOTIFICATION_TO: ${{ secrets.NOTIFICATION_TO }}
    DISABLE_EMAIL_NOTIFICATION: ${{ secrets.DISABLE_EMAIL_NOTIFICATION || 'false' }}

on:
  # æ¯å¤© UTC 01:13 æ‰§è¡Œ = åŒ—äº¬æ—¶é—´ 09:13 é¿å…æ•´ç‚¹æ—¶å¤§é‡æ’é˜Ÿ
  schedule:
    - cron: '13 1 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•ï¼‰
  push:
    branches:
      - main
    paths:
      - '.github/workflows/daily.yml'
      - 'src/**'
      - 'requirements.txt'

# é˜²æ­¢å¹¶å‘æ‰§è¡Œ
concurrency:
  group: ai-daily
  cancel-in-progress: false

# æƒé™é…ç½®
permissions:
  contents: write

jobs:
  build:
    name: ç”Ÿæˆ AI èµ„è®¯æ—¥æŠ¥
    runs-on: ubuntu-latest

    # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
    timeout-minutes: 30

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        run: |
          echo "Python ç‰ˆæœ¬: $(python --version)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "å½“å‰æ—¶é—´ (UTC): $(date -u)"
          echo "ç›®æ ‡æ—¥æœŸ (å‰ä¸¤å¤©): $(date -u -d '2 days ago' +%Y-%m-%d)"

      - name: è¿è¡Œ AI Daily ç”Ÿæˆå™¨
        env:
          # Claude API é…ç½®ï¼ˆä½¿ç”¨æ™ºè°±ä»£ç†ï¼‰
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}

          # é‚®ä»¶é€šçŸ¥é…ç½®
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          NOTIFICATION_TO: ${{ secrets.NOTIFICATION_TO }}

          # å›¾ç‰‡ç”Ÿæˆ API é…ç½®ï¼ˆFirefly Card APIï¼‰
          ENABLE_IMAGE_GENERATION: ${{ secrets.ENABLE_IMAGE_GENERATION || 'true' }}
          FIREFLY_API_URL: ${{ secrets.FIREFLY_API_URL || 'https://fireflycard-api.302ai.cn/api/saveImg' }}
          FIREFLY_API_KEY: ${{ secrets.FIREFLY_API_KEY }}

          # GitHub Pages URLï¼ˆç”¨äºé‚®ä»¶ä¸­çš„é“¾æ¥ï¼‰
          GITHUB_PAGES_URL: ${{ github.event.repository.html_url }}.github.io

          # GitHub ç¯å¢ƒå˜é‡ï¼ˆç”¨äºæ—¥å¿—é“¾æ¥ï¼‰
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
        run: |
          python src/main.py

      - name: æ£€æŸ¥ç”Ÿæˆç»“æœ
        run: |
          if [ ! -d "docs" ]; then
            echo "âŒ é”™è¯¯: docs ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "docs/index.html" ]; then
            echo "âŒ é”™è¯¯: index.html æœªç”Ÿæˆ"
            exit 1
          fi
          echo "âœ… æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
          ls -lh docs/

      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          keep_files: true
          commit_message: 'ğŸ¤– Auto update AI Daily - {{ date }}'
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-daily-output
          path: docs/
          retention-days: 7
